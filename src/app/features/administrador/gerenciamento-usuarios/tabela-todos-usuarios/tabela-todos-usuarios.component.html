<section class="usuarios-table-container">
  <!-- Header da tabela -->
  <div class="table-header">
    <div class="header-info">
      <h3>
        <i class="fa-solid fa-users"></i>
        Usuários do Sistema
      </h3>
      <span class="badge-count">{{ dataSource.length }} registros</span>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <span>Carregando usuários...</span>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && dataSource.length === 0" class="empty-state">
    <i class="fa-solid fa-users-slash fa-3x"></i>
    <h4>Nenhum usuário encontrado</h4>
    <p>Não há usuários que correspondam aos filtros aplicados.</p>
  </div>

  <!-- Tabela -->
  <div class="table-wrapper" *ngIf="!isLoading && dataSource.length > 0">
    <table mat-table [dataSource]="dataSource" class="usuarios-table">

      <!-- Coluna Index -->
      <ng-container matColumnDef="index">
        <th mat-header-cell *matHeaderCellDef class="col-index">#</th>
        <td mat-cell *matCellDef="let element; let i = index" class="col-index">
          <span class="index-badge">{{ i + 1 }}</span>
        </td>
      </ng-container>

      <!-- Coluna Nome -->
      <ng-container matColumnDef="nome">
        <th mat-header-cell *matHeaderCellDef class="col-nome">
          <i class="fa-solid fa-user"></i> Nome
        </th>
        <td mat-cell *matCellDef="let usuario" class="col-nome">
          <div class="user-info">
            <div class="user-avatar" [ngClass]="'avatar-' + usuario.categoria.toLowerCase()">
              <i class="fa-solid" [ngClass]="usuario.categoriaIcon"></i>
            </div>
            <div class="user-details">
              <span class="user-name">{{ usuario.nome }}</span>
              <span class="user-code">#{{ usuario.codigo }}</span>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Coluna Categoria -->
      <ng-container matColumnDef="categoria">
        <th mat-header-cell *matHeaderCellDef class="col-categoria">
          <i class="fa-solid fa-tag"></i> Categoria
        </th>
        <td mat-cell *matCellDef="let usuario" class="col-categoria">
          <span class="categoria-badge" [ngClass]="'categoria-' + usuario.categoria.toLowerCase()">
            <i class="fa-solid" [ngClass]="usuario.categoriaIcon"></i>
            {{ usuario.categoria }}
          </span>
        </td>
      </ng-container>

      <!-- Coluna Email -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef class="col-email">
          <i class="fa-solid fa-envelope"></i> Email
        </th>
        <td mat-cell *matCellDef="let usuario" class="col-email">
          <span class="email-text" [title]="usuario.email">
            {{ usuario.email || 'Não informado' }}
          </span>
        </td>
      </ng-container>

      <!-- Coluna Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef class="col-status">
          <i class="fa-solid fa-circle-check"></i> Status
        </th>
        <td mat-cell *matCellDef="let usuario" class="col-status">
          <span class="status-badge" [ngClass]="usuario.status ? 'status-ativo' : 'status-bloqueado'">
            <i class="fa-solid" [ngClass]="usuario.status ? 'fa-check-circle' : 'fa-ban'"></i>
            {{ usuario.status ? 'Ativo' : 'Bloqueado' }}
          </span>
        </td>
      </ng-container>

      <!-- Coluna Ações -->
      <ng-container matColumnDef="acoes">
        <th mat-header-cell *matHeaderCellDef class="col-acoes">
          <i class="fa-solid fa-gear"></i> Ações
        </th>
        <td mat-cell *matCellDef="let usuario" class="col-acoes">
          <div class="action-buttons">
            <!-- Botão Visualizar/Editar -->
            <button
              class="btn-action btn-visualizar"
              (click)="abrirVisualizarEditar(usuario); $event.stopPropagation()"
              title="Visualizar/Editar">
              <i class="fa-solid fa-eye"></i>
            </button>

            <!-- Botão Trocar Senha -->
            <button
              *ngIf="!isPaciente(usuario)"
              class="btn-action btn-senha"
              (click)="abrirTrocaSenha(usuario); $event.stopPropagation()"
              title="Alterar senha">
              <i class="fa-solid fa-key"></i>
            </button>

            <!-- Botão Bloquear/Desbloquear -->
            <button
              class="btn-action"
              [ngClass]="usuario.status ? 'btn-bloquear' : 'btn-desbloquear'"
              (click)="alternarStatusUsuario(usuario); $event.stopPropagation()"
              [title]="usuario.status ? 'Bloquear usuário' : 'Desbloquear usuário'">
              <i class="fa-solid" [ngClass]="usuario.status ? 'fa-lock-open' : 'fa-lock'"></i>
            </button>

            <!-- Botão Deletar -->
            <button
              class="btn-action btn-deletar"
              (click)="confirmarDelecao(usuario); $event.stopPropagation()"
              title="Excluir usuário">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          [ngClass]="{'row-bloqueado': !row.status}"
          (click)="abrirVisualizarEditar(row)"
          class="row-clicavel"
          title="Clique para visualizar/editar"></tr>
    </table>
  </div>

  <!-- Footer -->
  <div class="table-footer" *ngIf="!isLoading && dataSource.length > 0">
    <span class="footer-info">
      Exibindo {{ dataSource.length }} de {{ todosUsuarios.length }} usuários
    </span>
  </div>
</section>
